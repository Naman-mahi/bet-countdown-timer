<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Recording</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
    }
    .container {
      margin-top: 50px;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    }
    .btn-record {
      background-color: #eb4e4e;
      border-color: #eb4e4e;
    }
    .btn-record:hover {
      background-color: #c43e3e;
      border-color: #c43e3e;
    }
    .btn-stop {
      background-color: #6f42c1;
      border-color: #6f42c1;
    }
    .btn-stop:hover {
      background-color: #563d7c;
      border-color: #563d7c;
    }
    .btn-preview {
      background-color: #007bff;
      border-color: #007bff;
    }
    .btn-preview:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Record Video</h5>
            <div class="d-flex justify-content-center align-items-center">
              <div class="video-preview">
                <video id="preview" width="320" height="240" autoplay muted></video>
              </div>
              <div class="video-controls ms-4">
                <div class="text-center mb-3">
                  <button id="startButton" class="btn btn-record">Start Recording</button>
                  <button id="stopButton" class="btn btn-stop d-none">Stop Recording</button>
                  <a id="downloadButton" class="btn btn-success d-none">Download</a>
                  <button id="previewButton" class="btn btn-preview d-none">Preview</button>
                  <button id="rerecordButton" class="btn btn-record d-none">Record Again</button>
                </div>
                <div id="recordingContainer" class="text-center d-none mb-3">
                  <h4 class="text-danger">Recording...</h4>
                </div>
                <div id="timerContainer" class="text-center d-none">
                  <h4 class="text-primary" id="timer">1:00</h4>
                </div>
              </div>
            </div>
            <div class="bottom">
              <pre id="log"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS and Custom Script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let preview = document.getElementById("preview");
    let startButton = document.getElementById("startButton");
    let stopButton = document.getElementById("stopButton");
    let downloadButton = document.getElementById("downloadButton");
    let previewButton = document.getElementById("previewButton");
    let rerecordButton = document.getElementById("rerecordButton");
    let recordingContainer = document.getElementById("recordingContainer");
    let timerContainer = document.getElementById("timerContainer");
    let timerDisplay = document.getElementById("timer");
    let logElement = document.getElementById("log");
    let recordedChunks = [];

    let countdownTime = 3; // Countdown time in seconds
    let recordingTimeMS = 60000; // 1 minute in milliseconds

    function log(msg) {
      logElement.innerHTML += `${msg}\n`;
    }

    function startCountdown() {
      let countdownInterval = setInterval(() => {
        timerDisplay.textContent = countdownTime.toString();
        countdownTime--;
        if (countdownTime < 0) {
          clearInterval(countdownInterval);
          startRecording(preview.captureStream());
        }
      }, 1000);
    }

    function startRecording(stream) {
      let recorder = new MediaRecorder(stream);

      recorder.ondataavailable = (event) => recordedChunks.push(event.data);
      recorder.start();
      log(`Recording started for ${recordingTimeMS / 1000} seconds...`);

      setTimeout(() => {
        recorder.stop();
        stopButton.classList.add("d-none");
        previewButton.classList.remove("d-none");
        timerContainer.classList.add("d-none");
        log(`Recording stopped after ${recordingTimeMS / 1000} seconds.`);
      }, recordingTimeMS);
    }

    function stop(stream) {
      stream.getTracks().forEach((track) => track.stop());
    }

    startButton.addEventListener("click", () => {
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then((stream) => {
          preview.srcObject = stream;
          downloadButton.href = stream;
          preview.captureStream = preview.captureStream || preview.mozCaptureStream;
          return new Promise((resolve) => (preview.onplaying = resolve));
        })
        .then(() => {
          startButton.classList.add("d-none");
          recordingContainer.classList.remove("d-none");
          timerContainer.classList.remove("d-none");
          startCountdown();
        })
        .catch((error) => {
          if (error.name === "NotFoundError") {
            log("Camera or microphone not found. Can't record.");
          } else {
            log(error);
          }
        });
    });

    stopButton.addEventListener("click", () => {
      stop(preview.srcObject);
    });

    previewButton.addEventListener("click", () => {
      preview.src = URL.createObjectURL(new Blob(recordedChunks, { type: "video/webm" }));
      preview.controls = true;
      downloadButton.href = preview.src;
      downloadButton.classList.remove("d-none");
      previewButton.classList.add("d-none");
      rerecordButton.classList.remove("d-none");
    });

    rerecordButton.addEventListener("click", () => {
      recordedChunks = [];
      preview.src = "";
      downloadButton.href = "";
      preview.controls = false;
      rerecordButton.classList.add("d-none");
      startButton.classList.remove("d-none");
    });
  </script>
</body>
</html>
