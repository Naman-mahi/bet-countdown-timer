<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Recording</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
    }
    .container {
      margin-top: 50px;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    }
    .btn-record {
      background-color: #eb4e4e;
      border-color: #eb4e4e;
    }
    .btn-record:hover {
      background-color: #c43e3e;
      border-color: #c43e3e;
    }
    .btn-stop {
      background-color: #6f42c1;
      border-color: #6f42c1;
    }
    .btn-stop:hover {
      background-color: #563d7c;
      border-color: #563d7c;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Record Video</h5>
            <div class="d-flex justify-content-center align-items-center">
              <div class="video-preview">
                <video id="preview" width="320" height="240" autoplay muted></video>
              </div>
              <div class="video-controls ms-4">
                <div class="text-center mb-3">
                  <button id="startButton" class="btn btn-record">Start Recording</button>
                  <button id="stopButton" class="btn btn-stop d-none">Stop Recording</button>
                  <a id="downloadButton" class="btn btn-success d-none">Download</a>
                </div>
                <div id="recordingContainer" class="text-center d-none mb-3">
                  <h4 class="text-danger">Recording...</h4>
                </div>
                <div id="timerContainer" class="text-center d-none">
                  <h4 class="text-primary" id="timer">2:00</h4>
                </div>
              </div>
            </div>
            <div class="bottom">
              <pre id="log"></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS and Custom Script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let preview = document.getElementById("preview");
    let startButton = document.getElementById("startButton");
    let stopButton = document.getElementById("stopButton");
    let downloadButton = document.getElementById("downloadButton");
    let recordingContainer = document.getElementById("recordingContainer");
    let timerContainer = document.getElementById("timerContainer");
    let timerDisplay = document.getElementById("timer");
    let logElement = document.getElementById("log");

    let recordingTimeMS = 120000; // 2 minutes

    function log(msg) {
      logElement.innerHTML += `${msg}\n`;
    }

    function startRecording(stream) {
      let recorder = new MediaRecorder(stream);
      let data = [];

      recorder.ondataavailable = (event) => data.push(event.data);
      recorder.start();
      log(`Recording started for ${recordingTimeMS / 1000} seconds...`);

      let stopped = new Promise((resolve, reject) => {
        recorder.onstop = resolve;
        recorder.onerror = (event) => reject(event.name);
      });

      setTimeout(() => {
        recorder.stop();
        stopButton.classList.add("d-none");
        downloadButton.classList.remove("d-none");
        timerContainer.classList.add("d-none");
        log(`Recording stopped after ${recordingTimeMS / 1000} seconds.`);
      }, recordingTimeMS);

      return Promise.all([stopped]).then(() => data);
    }

    function stop(stream) {
      stream.getTracks().forEach((track) => track.stop());
    }

    startButton.addEventListener("click", () => {
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then((stream) => {
          preview.srcObject = stream;
          downloadButton.href = stream;
          preview.captureStream = preview.captureStream || preview.mozCaptureStream;
          return new Promise((resolve) => (preview.onplaying = resolve));
        })
        .then(() => {
          startButton.classList.add("d-none");
          stopButton.classList.remove("d-none");
          recordingContainer.classList.remove("d-none");
          timerContainer.classList.remove("d-none");
          startRecording(preview.captureStream());
          let remainingTime = recordingTimeMS / 1000;
          let timerInterval = setInterval(() => {
            remainingTime--;
            timerDisplay.textContent = formatTime(remainingTime);
            if (remainingTime <= 0) clearInterval(timerInterval);
          }, 1000);
        })
        .catch((error) => {
          if (error.name === "NotFoundError") {
            log("Camera or microphone not found. Can't record.");
          } else {
            log(error);
          }
        });
    });

    stopButton.addEventListener("click", () => {
      stop(preview.srcObject);
    });

    function formatTime(seconds) {
      let mins = Math.floor(seconds / 60);
      let secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, "0")}`;
    }
  </script>
</body>
</html>
